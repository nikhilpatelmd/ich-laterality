---
title: "Hemispheric Lateralization and Outcomes After ICH: A Pooled Analysis of Clinical Trials"
subtitle: "Study Protocol"
author: "Nikhil Patel, MD"
format: 
  html:
    toc: true
    toc-location: left
    toc-title: ""
    css: styles.css
    anchor-sections: true
    code-fold: true
    code-overflow: wrap
    code-summary: "Show the code"
    output: false
---

## Introduction

Patients with neurological injury experience different symptoms between the left and right hemispheres. This may affect prognostic estimates, and how frequently patients are offered aggressive care. In this study, we aimed to investigate any differential treatment patterns based on hemispheric lateralization, as well as differences in outcome with a pooled analysis of NINDS randomized trials enrolling patients with ICH.


## Methods

**Loading packages and data and define helper functions**

```{r Initial Setup}

library(tidyverse)
library(tableone)
library(data.table)
library(haven) # Importing SAS Files
library(janitor)
library(lubridate)
library(readxl)
library(Hmisc)

```

**Importing and wrangling ATACH2 data**

```{r ATACH2}

# Create function to paste together string of FORMxx.txt
atach.import <- function(y) {
  dataset <- paste0("atach2",".",y)
  filepath <- paste0("./ATACH2/FORM",y,".txt")
  dataset <- read.table(filepath, sep = "\t", header = TRUE)
}

atach00 <- atach.import("00")
atach01 <- atach.import("01")
atach02 <- atach.import("02")
atach03 <- atach.import("03")
atach04 <- atach.import("04")
atach05 <- atach.import("05")
# atach05c <- atach.import("05c") Detailed Blood Pressure Data, Unsure if Needed
atach06 <- atach.import("06")
atach07 <- atach.import("07")
atach08 <- atach.import("08")
atach09 <- atach.import("09")
atach10 <- atach.import("10")
atach11 <- atach.import("11")
atach13 <- atach.import("13")
atach14 <- atach.import("14")
atach15 <- atach.import("15")
atach16 <- atach.import("16")
atach17 <- atach.import("17")
atach18 <- atach.import("18")
atach20 <- atach.import("20")
atach21 <- atach.import("21")
atach23 <- atach.import("23")
atach33 <- atach.import("33")
atachct <- read.table("./ATACH2/CTCR.txt", sep = "\t", header = TRUE)

# Merging all tidy data
atach.tidy <- list(atach00, atach01, atach02, atach03, atach04, atach05, atach07, atach08, atach11, atach16, atach17, atach21, atach33)
atach.whole <- reduce(atach.tidy, full_join, by = "SUBJECT_ID")
atach.whole <-atach.whole %>% mutate(study = "ATACH2")

# Importing CT Data
atachct <- atachct %>%
  mutate(ctnumber = case_when(
    CTCRMIN < 0 ~ "baseline",
    CTCRMIN > 0 ~ "24hourpost"
  ))

# Extracting First CT Data
atachctbaseline <- atachct %>% 
  filter(ctnumber == "baseline") %>%
  select(SUBJECT_ID, CTCRMIN, CTCRQ05, CTCRQ07, CTCRQ08, CTCRQ09, CTCRQ12, CTCRQ13, CTCRQ11, CTCRQ14) %>%
  rename(CTCRMIN.baseline = CTCRMIN) %>%
  rename(ich.location.baseline = CTCRQ05) %>%
  rename(ivh.baseline = CTCRQ07) %>%
  rename(hydrocephalus.baseline = CTCRQ08) %>%
  rename(pineal.shift.baseline = CTCRQ09) %>%
  rename(ich.volume.baseline = CTCRQ12) %>%
  rename(ivh.volume.baseline = CTCRQ13) %>%
  rename(phe.volume.baseline = CTCRQ11) %>%
  rename(sp.shift.baseline = CTCRQ14)


atachct24hrpost <- atachct %>% # Extracting Second CT Data
  filter(ctnumber == "24hourpost") %>%
    select(SUBJECT_ID, CTCRMIN, CTCRQ05, CTCRQ07, CTCRQ08, CTCRQ09, CTCRQ12, CTCRQ13, CTCRQ11, CTCRQ14) %>%
  rename(CTCRMIN.24hourpost = CTCRMIN) %>%
  rename(ich.location.24hourpost = CTCRQ05) %>%
  rename(ivh.24hourpost = CTCRQ07) %>%
  rename(hydrocephalus.24hourpost = CTCRQ08) %>%
  rename(pineal.shift.24hourpost = CTCRQ09) %>%
  rename(ich.volume.24hourpost = CTCRQ12) %>%
  rename(ivh.volume.24hourpost = CTCRQ13) %>%
  rename(phe.volume.24hourpost = CTCRQ11) %>%
  rename(sp.shift.24hourpost = CTCRQ14)

atach.whole <- left_join(atach.whole, atachctbaseline, by = "SUBJECT_ID")
atach.whole <- left_join(atach.whole, atachct24hrpost, by = "SUBJECT_ID")


# Importing mRS Data

atachmrs30 <- atach09 %>%
  filter(mrsday == 30) %>%
  select(SUBJECT_ID, F09Q01) %>%
  rename(mrs.30 = F09Q01)

atachmrs90 <- atach09 %>%
  filter(mrsday == 90) %>%
  select(SUBJECT_ID, F09Q01) %>%
  rename(mrs.90 = F09Q01)

atach.whole <-left_join(atach.whole, atachmrs30, by = "SUBJECT_ID")
atach.whole <-left_join(atach.whole, atachmrs90, by = "SUBJECT_ID")

# Categorizing and Recoding Variables

# Race
atach.whole <- atach.whole %>%
  mutate(race = case_when(
    F01Q03M1 == 1 ~ "American Indian or Alaskan Native",
    F01Q03M2 == 1 ~ "Asian",
    F01Q03M3 == 1 ~ "Black or African-American",
    F01Q03M5 == 1 ~ "White",
    F01Q03M6 == 1 ~ "Other/Not Reported",
    F01Q03M7 == 1 ~ "Other/Not Reported"
  ))

# Ethnicity
atach.whole <- atach.whole %>% 
  mutate(ethnicity = recode(F01Q02,
                             "1" = "Hispanic or Latino",
                             "2" = "Not Hispanic or Latino",
                             .default = "Unknown/Not Reported"
                             ))

# Sex
atach.whole <- atach.whole %>% 
  mutate(sex = dplyr::recode(F01Q01,
                      "1" = "Male",
                      "2" = "Female"))

# Country of Enrolling Site
atach.whole <- atach.whole %>% 
  mutate(enrolling.country = recode(COUNTRY,
                                    "1" = "United States",
                                    "2" = "Japan",
                                    "3" = "China",
                                    "4" = "South Korea",
                                    "5" = "Taiwan",
                                    "6" = "Germany"))

# Past Medical History
atach.whole <- atach.whole %>%
  mutate(stroke = recode(F03Q01,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(chf = recode(F03Q03,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(afib = recode(F03Q04,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(cad = case_when(
    F03Q05 == 0 ~ "No",
    F03Q05 == 1 ~ "Yes",
    F03Q05 == 98 ~ "NA",
    F03Q06 == 0 ~ "No",
    F03Q06 == 1 ~ "Yes",
    F03Q06 == 98 ~ "NA"
  ))

atach.whole <- atach.whole %>%
  mutate(htn = recode(F03Q07,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(pvd = recode(F03Q08,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(hld = recode(F03Q09,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(dm2 = recode(F03Q12,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(tobacco = recode(F03Q13,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

# ICH Laterality
atach.whole <- atach.whole %>%
  mutate(ich.laterality = recode(ich.location.baseline,
                                 "1" = "Right",
                                 "2" = "Right",
                                 "3" = "Right",
                                 "4" = "Left",
                                 "5" = "Left",
                                 "6" = "Left",
                                 .default = "NA"))

# ICH Location
atach.whole <- atach.whole %>%
  mutate(ich.location.baseline = recode(ich.location.baseline,
                                        "1" = "Thalamus",
                                        "2" = "Basal Ganglia",
                                        "3" = "Lobar",
                                        "4" = "Thalamus",
                                        "5" = "Basal Ganglia",
                                        "6" = "Lobar",
                                        "7" = "Pons",
                                        "8" = "Cerebellum"))

atach.whole <- atach.whole %>%
  mutate(ivh = recode(ivh.baseline,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(hydrocephalus = recode(hydrocephalus.baseline,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(hydrocephalus = recode(hydrocephalus.baseline,
                         "0" = "No",
                         "1" = "Yes",
                         "98" = "NA"))

atach.whole <- atach.whole %>%
  mutate(ich.volume.cc = ich.volume.baseline/1000)

atach.whole <- atach.whole %>%
  mutate(phe.volume.cc = phe.volume.baseline/1000)

atach.whole <- atach.whole %>%
  mutate(ivh.volume.cc = ivh.volume.baseline/1000)

atach.whole <- atach.whole %>%
  mutate(mech.ventilation = recode(F07Q01,
                                   "0" = "No",
                                   "1" = "Yes",
                                   .default = "NA"))

atach.whole <- atach.whole %>%
  mutate(evd = recode(F07Q05,
                                   "0" = "No",
                                   "1" = "Yes",
                                   .default = "NA"))

atach.whole <- atach.whole %>%
  mutate(nsgy.evacuation = recode(F07Q08,
                                   "0" = "No",
                                   "1" = "Yes",
                                   .default = "NA"))

atach.whole <- atach.whole %>%
  mutate(tracheostomy = recode(F07Q11,
                                   "0" = "No",
                                   "1" = "Yes",
                                   .default = "NA"))

# NIHSS
atach.nihss.baseline <- atach10 %>%
  filter(nihss.assessment == "baseline") %>%
  select(SUBJECT_ID, F10Q22) %>%
  rename(nihss.baseline = F10Q22)

atach.nihss.24hourpost <- atach10 %>%
  filter(nihss.assessment == "24hourpost") %>%
  select(SUBJECT_ID, F10Q22) %>%
  rename(nihss.24hourpost = F10Q22)
  

atach.whole <-left_join(atach.whole, atach.nihss.baseline, by = "SUBJECT_ID")
atach.whole <-left_join(atach.whole, atach.nihss.24hourpost, by = "SUBJECT_ID")


# EuroQol

atach.whole <- atach.whole %>%
  mutate(euro.mobility.90 = factor(F16Q02,
                                labels = c("No Problems", "Some Problems", "Confined to Bed")))

atach.whole <- atach.whole %>%
  mutate(euro.selfcare.90 = factor(F16Q03,
                                labels = c("No Problems", "Some Problems", "Unable to Wash or Dress Myself")))

atach.whole <- atach.whole %>%
  mutate(euro.usual.90 = factor(F16Q04,
                                labels = c("No Problems", "Some Problems", "Unable to Perform My Usual Activities")))

atach.whole <- atach.whole %>%
  mutate(euro.pain.90 = factor(F16Q05,
                                labels = c("No Pain/Discomfort", "Some Moderate Pain/Discomfort", "Extreme Pain/Discomfort")))

atach.whole <- atach.whole %>%
  mutate(euro.anxiety.90 = factor(F16Q06,
                                labels = c("Not Anxious/Depressed", "Moderately Anxious/Depressed", "Extremely Anxious/Depressed")))


# Filtering out cases without ICH laterality
atach.whole <- atach.whole %>%
  filter(ich.laterality != "NA")

# Renaming variables

atach.whole <- atach.whole %>%
  rename(age = F33Q02) %>%
  rename(symptom.onset = F00Q02MIN) %>% # All times in ATACH2 dataset are expressed as minutes from randomization
  rename(arrivaltime.initial = F02Q03MIN) %>% 
  rename(arrivaltime.strokecenter = F02Q05MIN) %>%
  rename(sbp.initial = F05Q07A) %>%
  rename(dbp.initial = F05Q07B) %>%
  rename(gcs.baseline = F33Q04) %>%
  rename(intubation.days = F07Q02) %>%
  rename(extubation.date = F07Q03DAY) %>%
  rename(trach.date = F07Q04DAY) %>%
  rename(evd.days = F07Q07) %>%
  rename(nsgy.evacuation.date = F07Q09DAY) %>%
  rename(euro.vas.90 = F16Q07) %>%
  rename(EQ_INDEX.90 = EQ_INDEX)

# Calculating Time to ED Presentation as expressed by minutes and hours from symptom onset

atach.whole <- atach.whole %>%
  mutate(time.to.ed.minutes = abs(arrivaltime.strokecenter - symptom.onset)) %>%
  mutate(time.to.ed.hours = time.to.ed.minutes / 60)

atach.whole$time.to.ed.hours <- round(atach.whole$time.to.ed.hours, digits = 2)

atach.times <- atach.whole %>%
  select(c(symptom.onset, arrivaltime.initial, arrivaltime.strokecenter, time.to.ed.minutes, time.to.ed.hours))

# DNR and WLST status

atach.whole <- atach.whole %>%
  mutate(dnr.binary = case_when(
    F21Q08 == "0" ~ "No",
    F21Q08 == "1" ~ "Yes"
  ))

atach.whole <- atach.whole %>%
  mutate(comfort.binary = case_when(
    F21Q06 == "0" ~ "No",
    F21Q06 == "1" ~ "Yes"
  ))

atach.whole <- atach.whole %>%
  rename(comfort.day = F21Q07DAY) %>%
  rename(dnr.day = F21Q09DAY)


```

**Importing and wrangling ERICH data**

```{r ERICH}

erich.case <- read_sas("ERICH/erich_case_100217.sas7bdat")

erich.whole <- erich.case %>%
  select(ID, age, gender, Race, Ethnicity, D6, D7, D7A, D21, D21A, D22, D25, PHY4, PHY6, PHY6A, PHY9, 1510, 1511, 1512, ED7, ED8, ED36, ED37, ED38, ED39, ED44, ED47_SYS, ED47_DIAS, SH1, SH8, SH9, SH10, SMK1A, MHX1, MHX3, MHX3A, MHX6, MHX8, MHX9, MHX11, MHX12, MHX13, MHX13A, MHX14, MHX16, MHX18, MHX20, MHX21, MHX22, MHX27C, MHX28, SA1, SA4, SA5A, SA6, SE1, SE2, SE3, SE15, LAB5, LAB6, IT5D, detail, ICH_Loc_CT1, ICH_Vol_CT1, IVH_Vol_CT1, ICH_Vol_CT2, ICH_Vol_CT3, ICH_Vol_CT4, IVH_Present, IT5D_DATE, IT5D_TIME, IT5H, IT5H_DATE, IT5H_TIME, IT5I, IT5I_DATE, IT5I_TIME, IT5F, IT5F_SPEC, IT5F_DATE, IT5F_TIME, IT7, IT8, IT8A, IT8B, IT13, IT13A, IT24, IT24A_DATE, IT24A_TIME, IT24A_UNITS, IT29, IT29A, IT29B, IT21, IT22, IT25, IT23, IT28, CC16, CC16_DATE, CC16_TIME, CC17, CC17_DATE, CC17_TIME, CC18, CC18_DATE, CC18_TIME, CX15, CX27, CX30, O3, O3A, O5, O20, AU8, AU8_OTH, RANKIN_FU1, RANKIN_FU2, RANKIN_FU3, MOBILITY_FU1, MOBILITY_FU2, MOBILITY_FU3, SELFCARE_FU1, SELFCARE_FU2, SELFCARE_FU3, USUALACT_FU1, USUALACT_FU2, USUALACT_FU3, PAIN_FU1, PAIN_FU2, PAIN_FU3, ANXIETY_FU1, ANXIETY_FU2, ANXIETY_FU3, HLTHSTAT_FU1, HLTHSTAT_FU2, HLTHSTAT_FU3, FEED_FU1, FEED_FU2, FEED_FU3, BATHE_FU1, BATHE_FU2, BATHE_FU3, GROOM_FU1, GROOM_FU2, GROOM_FU3, DRESS_FU1, DRESS_FU2, DRESS_FU3, BOWELS_FU1, BOWELS_FU2, BOWELS_FU3, BLADDER_FU1, BLADDER_FU2, BLADDER_FU3, TOILET_FU1, TOILET_FU2, TOILET_FU3, TRANSFER_FU1, TRANSFER_FU2, TRANSFER_FU3, MOBLEVEL_FU1, MOBLEVEL_FU2, MOBLEVEL_FU3, STAIRS_FU1, STAIRS_FU2, STAIRS_FU3, BART_TOT_FU1, BART_TOT_FU2, BART_TOT_FU3, EMS33, ED44, CURR_LOC_FU1, CURR_LOC_FU2, CURR_LOC_FU3, IT2, O1, O2_DATE, O2_TIME, O3, O3_OTH, DOD)

erich.whole <- erich.whole %>%
  mutate(study = "ERICH")

erich.whole <- erich.whole %>%
  mutate(enrolling.country = "United States")

# Renaming and Recoding Variables

erich.whole <- erich.whole %>%
  mutate(gender = recode(gender,
                         "F" = "Female",
                         "M" = "Male")) %>%
  rename(sex = gender)

erich.whole <- erich.whole %>%
  mutate(Race = case_when(
    D21 == "W" ~ "White",
    D21 == "B" ~ "Black or African-American",
    D21 == "A" ~ "Asian",
    D21 == "N" ~ "Native Hawaiian/Pacific Islander",
    D21 == "I" ~ "American Indian or Alaskan Native",
    D21 == "O" ~ "Other/Not Reported",
    D21 == "U" ~ "Other/Not Reported"
    )) %>%
  rename(race = Race)

erich.whole <- erich.whole %>%
  mutate(ethnicity = case_when(
    D21A == "H" ~ "Hispanic or Latino",
    D21A == "N" ~ "Not Hispanic or Latino",
    D21A == "U" ~ "Not Hispanic or Latino"
  ))

erich.whole <- erich.whole %>%
  mutate(stroke = recode(SH1,
                         "2" = "No",
                         "1" = "Yes",
                         "8" = "NA"))

erich.whole <- erich.whole %>%
  mutate(cad = recode(MHX8,
                         "2" = "No",
                         "1" = "Yes",
                         "8" = "NA"))

erich.whole <- erich.whole %>%
  mutate(chf = recode(MHX13,
                         "2" = "No",
                         "1" = "Yes",
                         "8" = "NA"))

erich.whole <- erich.whole %>%
  mutate(afib = recode(MHX11,
                         "2" = "No",
                         "1" = "Yes",
                         "8" = "NA"))

erich.whole <- erich.whole %>%
  mutate(pvd = recode(MHX27C,
                         "2" = "No",
                         "1" = "Yes",
                         "8" = "NA"))

erich.whole <- erich.whole %>%
  mutate(hld = recode(MHX6,
                         "2" = "No",
                         "1" = "Yes",
                         "8" = "NA"))

erich.whole <- erich.whole %>%
  mutate(dm2 = case_when(
    MHX3 == "2" ~ "No",
    MHX3 == "8" ~ "NA",
    MHX3A == "1" ~ "No",
    MHX3A == "2" ~ "Yes",
    MHX3A == "8" ~ "NA"))

erich.whole <- erich.whole %>%
  mutate(tobacco = recode(SMK1A,
                         "2" = "No",
                         "1" = "Yes",
                         "5" = "NA",
                         "8" = "NA"))

erich.whole <- erich.whole %>%
  rename(sbp.initial = ED47_SYS)

erich.whole <- erich.whole %>%
  rename(dbp.initial = ED47_DIAS)

erich.whole <- erich.whole %>%
  rename(gcs.baseline = ED39)

erich.whole <- erich.whole %>%
  mutate(ich.laterality = recode(PHY6A,
                                 "L" = "Left",
                                 "R" = "Right",
                                 "M" = "NA",
                                 .default = "NA"))

# ICH Location
erich.whole <- erich.whole %>%
  mutate(
    ich.location.baseline = case_when(
      str_detect(erich.whole$detail, "Ganglia") ~ "Basal Ganglia",
      str_detect(erich.whole$detail, "Brainstem") ~ "Brainstem",
      str_detect(erich.whole$detail, "Cerebell") ~ "Cerebellum",
      str_detect(erich.whole$detail, "Front") ~ "Lobar",
      str_detect(erich.whole$detail, "Tempor") ~ "Lobar",
      str_detect(erich.whole$detail, "Occi") ~ "Lobar",
      str_detect(erich.whole$detail, "Perivent") ~ "Basal Ganglia",
      str_detect(erich.whole$detail, "Caudate") ~ "Basal Ganglia",
      str_detect(erich.whole$detail, "Putam") ~ "Basal Ganglia",
      str_detect(erich.whole$detail, "Deep") ~ "Basal Ganglia",
      str_detect(erich.whole$detail, "Lobar") ~ "Lobar",
      str_detect(erich.whole$detail, "IVH") ~ "Primary IVH",
      str_detect(erich.whole$detail, "Hemis") ~ "Lobar",
      str_detect(erich.whole$detail, "Thal") ~ "Thalamus",
      str_detect(erich.whole$detail, "Ganglia") ~ "Basal Ganglia",
      str_detect(erich.whole$detail, "Corona") ~ "Lobar",
      str_detect(erich.whole$detail, "applic") ~ "NA",
      detail == "Unknown" ~ "NA"
      ))

erich.whole <- erich.whole %>%
  mutate(ivh = case_when(erich.case$IVH_Vol_CT1 > 0 ~ "Yes",
                         erich.case$IVH_Vol_CT1 < 0.1 ~ "No"))

erich.whole <- erich.whole %>%
  rename(ich.volume.cc = ICH_Vol_CT1)

erich.whole <- erich.whole %>%
  rename(ivh.volume.cc = IVH_Vol_CT1)

erich.whole <- erich.whole %>%
  mutate(mech.ventilation = case_when(
    EMS33 == "1" ~ "Yes",
    EMS33 == "2" ~ "No",
    ED44 == "1" ~ "Yes",
    ED44 == "2" ~ "No",
    IT7 == "1" ~ "Yes",
    IT7 == "2" ~ "No"))

erich.whole <- erich.whole %>%
  mutate(evd = case_when(
    IT8 == "1" ~ "Yes",
    IT8 == "2" ~ "No",
    str_detect(erich.whole$IT5F_SPEC, "VENTR") ~ "Yes",
  ))

erich.whole <- erich.whole %>%
  mutate(nsgy.evacuation = case_when(
    IT5D == "1" ~ "Yes",
    IT5H == "1" ~ "Yes",
    str_detect(erich.whole$IT5F_SPEC, "CRANI") ~ "Yes",
    str_detect(erich.whole$IT5F_SPEC, "EVAC") ~ "Yes",
    TRUE ~ "No"
      ))

erich.whole <- erich.whole %>%
  rename(mrs.90 = RANKIN_FU1) %>%
  rename(mrs.180 = RANKIN_FU2) %>%
  rename(mrs.365 = RANKIN_FU3) %>%
  rename(euro.vas.90 = HLTHSTAT_FU1) %>%
  rename(euro.vas.180 = HLTHSTAT_FU2) %>%
  rename(euro.vas.365 = HLTHSTAT_FU3) %>%
  rename(barthel.feeding.90 = FEED_FU1) %>%
  rename(barthel.bathing.90 = BATHE_FU1) %>%
  rename(barthel.grooming.90 = GROOM_FU1) %>%
  rename(barthel.dressing.90 = DRESS_FU1) %>%
  rename(barthel.bowels.90 = BOWELS_FU1) %>%
  rename(barthel.bladder.90 = BLADDER_FU1) %>%
  rename(barthel.toilet.90 = TOILET_FU1) %>%
  rename(barthel.transfer.90 = TRANSFER_FU1) %>%
  rename(barthel.mobility.90 = MOBLEVEL_FU1) %>%
  rename(barthel.stairs.90 = STAIRS_FU1) %>%
  rename(barthel.total.90 = BART_TOT_FU1) %>%
  rename(barthel.feeding.180 = FEED_FU2) %>%
  rename(barthel.bathing.180 = BATHE_FU2) %>%
  rename(barthel.grooming.180 = GROOM_FU2) %>%
  rename(barthel.dressing.180 = DRESS_FU2) %>%
  rename(barthel.bowels.180 = BOWELS_FU2) %>%
  rename(barthel.bladder.180 = BLADDER_FU2) %>%
  rename(barthel.toilet.180 = TOILET_FU2) %>%
  rename(barthel.transfer.180 = TRANSFER_FU2) %>%
  rename(barthel.mobility.180 = MOBLEVEL_FU2) %>%
  rename(barthel.stairs.180 = STAIRS_FU2) %>%
  rename(barthel.total.180 = BART_TOT_FU2) %>%
  rename(barthel.feeding.365 = FEED_FU3) %>%
  rename(barthel.bathing.365 = BATHE_FU3) %>%
  rename(barthel.grooming.365 = GROOM_FU3) %>%
  rename(barthel.dressing.365 = DRESS_FU3) %>%
  rename(barthel.bowels.365 = BOWELS_FU3) %>%
  rename(barthel.bladder.365 = BLADDER_FU3) %>%
  rename(barthel.toilet.365 = TOILET_FU3) %>%
  rename(barthel.transfer.365 = TRANSFER_FU3) %>%
  rename(barthel.mobility.365 = MOBLEVEL_FU3) %>%
  rename(barthel.stairs.365 = STAIRS_FU3) %>%
  rename(barthel.total.365 = BART_TOT_FU3)

erich.whole <- erich.whole %>%
  mutate(current.location.90 = recode(CURR_LOC_FU1,
                      "1" = "Home",
                      "2" = "Rehabilitation",
                      "3" = "Skilled Nursing Facility",
                      "4" = "Hospital",
                      "7" = "Other"
                      )) %>%
  mutate(current.location.180 = recode(CURR_LOC_FU1,
                      "1" = "Home",
                      "2" = "Rehabilitation",
                      "3" = "Skilled Nursing Facility",
                      "4" = "Hospital",
                      "7" = "Other"
                      )) %>%
  mutate(current.location.365 = recode(CURR_LOC_FU1,
                      "1" = "Home",
                      "2" = "Rehabilitation",
                      "3" = "Skilled Nursing Facility",
                      "4" = "Hospital",
                      "7" = "Other"
                      ))

erich.whole <- erich.whole %>%
  mutate(euro.mobility.90 = factor(MOBILITY_FU1,
                                labels = c("No Problems", "Some Problems", "Confined to Bed", "NA")))

erich.whole <- erich.whole %>%
  mutate(euro.selfcare.90 = factor(SELFCARE_FU1,
                                labels = c("No Problems", "Some Problems", "Unable to Wash or Dress Myself", "NA")))

erich.whole <- erich.whole %>%
  mutate(euro.usual.90 = factor(USUALACT_FU1,
                                labels = c("No Problems", "Some Problems", "Unable to Perform My Usual Activities", "NA")))

erich.whole <- erich.whole %>%
  mutate(euro.pain.90 = factor(PAIN_FU1,
                                labels = c("No Pain/Discomfort", "Some Moderate Pain/Discomfort", "Extreme Pain/Discomfort", "NA")))

erich.whole <- erich.whole %>%
  mutate(euro.anxiety.90 = factor(ANXIETY_FU1,
                                labels = c("Not Anxious/Depressed", "Moderately Anxious/Depressed", "Extremely Anxious/Depressed", "NA")))

erich.whole <- erich.whole %>%
  mutate(euro.mobility.180 = factor(MOBILITY_FU2,
                                labels = c("No Problems", "Some Problems", "Confined to Bed")))

erich.whole <- erich.whole %>%
  mutate(euro.selfcare.180 = factor(SELFCARE_FU2,
                                labels = c("No Problems", "Some Problems", "Unable to Wash or Dress Myself")))

erich.whole <- erich.whole %>%
  mutate(euro.usual.180 = factor(USUALACT_FU2,
                                labels = c("No Problems", "Some Problems", "Unable to Perform My Usual Activities")))

erich.whole <- erich.whole %>%
  mutate(euro.pain.180 = factor(PAIN_FU2,
                                labels = c("No Pain/Discomfort", "Some Moderate Pain/Discomfort", "Extreme Pain/Discomfort")))

erich.whole <- erich.whole %>%
  mutate(euro.anxiety.180 = factor(ANXIETY_FU2,
                                labels = c("Not Anxious/Depressed", "Moderately Anxious/Depressed", "Extremely Anxious/Depressed")))

erich.whole <- erich.whole %>%
  mutate(euro.mobility.365 = factor(MOBILITY_FU3,
                                labels = c("No Problems", "Some Problems", "Confined to Bed")))

erich.whole <- erich.whole %>%
  mutate(euro.selfcare.365 = factor(SELFCARE_FU3,
                                labels = c("No Problems", "Some Problems", "Unable to Wash or Dress Myself")))

erich.whole <- erich.whole %>%
  mutate(euro.usual.365 = factor(USUALACT_FU3,
                                labels = c("No Problems", "Some Problems", "Unable to Perform My Usual Activities")))

erich.whole <- erich.whole %>%
  mutate(euro.pain.365 = factor(PAIN_FU3,
                                labels = c("No Pain/Discomfort", "Some Moderate Pain/Discomfort", "Extreme Pain/Discomfort")))

erich.whole <- erich.whole %>%
  mutate(euro.anxiety.365 = factor(ANXIETY_FU3,
                                labels = c("Not Anxious/Depressed", "Moderately Anxious/Depressed", "Extremely Anxious/Depressed")))


# Parsing Dates and Times in ERICH

# symptom.onset

erich.whole <- erich.whole %>%
  mutate(symptom.onset.date.time = ymd_hms(paste(erich.whole$SE1, erich.whole$SE2)))

erich.whole <- erich.whole %>%
  mutate(symptom.onset.estimated.time = case_when( # Converting estimated times to numbers
    SE3 == "1" ~ "06:00:00",
    SE3 == "2" ~ "NA",
    SE3 == "3" ~ "03:00:00",
    SE3 == "4" ~ "09:00:00",
    SE3 == "5" ~ "15:00:00",
    SE3 == "6" ~ "21:00:00"
  ))

erich.whole$symptom.onset.estimated.time <- hms(erich.whole$symptom.onset.estimated.time)

erich.whole <- erich.whole %>%
  mutate(symptom.onset.estimated.date.time = ymd_hms(paste(erich.whole$SE1, erich.whole$symptom.onset.estimated.time)))

erich.whole <- erich.whole %>%
  mutate(symptom.onset.combined = case_when(
    is.na(symptom.onset.date.time) ~ symptom.onset.estimated.date.time,
    TRUE ~ symptom.onset.date.time
  ))

# Time of ED presentation

erich.whole <- erich.whole %>%
  mutate(ed.presentation.date.time = ymd_hms(paste(erich.whole$ED7, erich.whole$ED8)))

# Calculating Time to ED Presentation as expressed by minutes and hours from symptom onset

erich.whole$symptom.onset.interval <- as.period(erich.whole$symptom.onset.combined %--% erich.whole$ed.presentation.date.time)
erich.whole$time.to.ed.minutes <- time_length(erich.whole$symptom.onset.interval, unit = "minutes")
erich.whole$time.to.ed.hours <- time_length(erich.whole$symptom.onset.interval, unit = "hours")

erich.whole$time.to.ed.minutes[erich.whole$time.to.ed.minutes < 0] = NA
erich.whole$time.to.ed.hours[erich.whole$time.to.ed.hours < 0] = NA


# Neurosurgery Dates

erich.whole <- erich.whole %>%
  mutate(nsgy.evacuation.date.erich = case_when(
    IT5D == "1" ~ ymd_hms(paste(IT5D_DATE, IT5D_TIME)),
    IT5H == "1" ~ ymd_hms(paste(IT5H_DATE, IT5H_TIME)),
    IT5F == "1" ~ ymd_hms(paste(IT5F_DATE, IT5F_TIME))
  ))

erich.whole$nsgy.interval <- as.period(erich.whole$symptom.onset.combined %--% erich.whole$nsgy.evacuation.date.erich)
erich.whole$nsgy.interval <- time_length(erich.whole$nsgy.interval, unit = "days")
erich.whole$nsgy.evacuation.date <- round(erich.whole$nsgy.interval, digits = 0) # Makes it compatible to merge with ATACH


# DNR and WLST Status

erich.whole <- erich.whole %>%
  mutate(dnr.binary = case_when(
    CC16 == "1" ~ "Yes",
    CC16 == "2" ~ "No",
    TRUE ~ "NA"
  ))

erich.whole <- erich.whole %>%
  mutate(dni.binary = case_when(
    CC17 == "1" ~ "Yes",
    CC17 == "2" ~ "No",
    TRUE ~ "NA"
  ))

erich.whole <- erich.whole %>%
  mutate(comfort.binary = case_when(
    CC18 == "1" ~ "Yes",
    CC18 == "2" ~ "No",
    TRUE ~ "NA"
  ))

erich.whole <- erich.whole %>%
  mutate(dnr.date.time = case_when(
    CC16 == "1" ~ ymd_hms(paste(CC16_DATE, CC16_TIME))
  ))

erich.whole$dnr.interval <- as.period(erich.whole$symptom.onset.combined %--% erich.whole$dnr.date.time)
erich.whole$dnr.interval <- time_length(erich.whole$dnr.interval, unit = "days")
erich.whole$dnr.day <- round(erich.whole$dnr.interval, digits = 0)

erich.whole <- erich.whole %>%
  mutate(dni.date.time = case_when(
    CC17 == "1" ~ ymd_hms(paste(CC17_DATE, CC17_TIME))
  ))

erich.whole$dni.interval <- as.period(erich.whole$symptom.onset.combined %--% erich.whole$dni.date.time)
erich.whole$dni.interval <- time_length(erich.whole$dni.interval, unit = "days")
erich.whole$dni.day <- round(erich.whole$dni.interval, digits = 0)

erich.whole <- erich.whole %>%
  mutate(comfort.date.time = case_when(
    CC18 == "1" ~ ymd_hms(paste(CC18_DATE, CC18_TIME))
  ))

erich.whole$comfort.interval <- as.period(erich.whole$symptom.onset.combined %--% erich.whole$comfort.date.time)
erich.whole$comfort.interval <- time_length(erich.whole$comfort.interval, unit = "days")
erich.whole$comfort.day <- round(erich.whole$comfort.interval, digits = 0)

# Mortality Status and Adding mRS 6

erich.whole$death.date <- ymd(erich.whole$DOD)

erich.whole$death.interval <- erich.whole$symptom.onset.combined %--% erich.whole$death.date
erich.whole$death.interval <- as.period(erich.whole$death.interval)
erich.whole$death.interval <- time_length(erich.whole$death.interval, unit = "days")

erich.whole <- erich.whole %>%
  mutate(mrs.90 = case_when(
    death.interval < 90 ~ 6,
    TRUE ~ mrs.90
    ))

erich.whole$mrs.90 <- na_if(erich.whole$mrs.90, 8)

erich.whole <- erich.whole %>%
  mutate(mrs.180 = case_when(
    death.interval < 180 ~ 6,
    TRUE ~ mrs.180
    ))

erich.whole <- erich.whole %>%
  mutate(mrs.365 = case_when(
    death.interval < 365 ~ 6,
    TRUE ~ mrs.365
    ))

# Adding tracheostomy information

erich.whole <- erich.whole %>%
  mutate(
    tracheostomy = case_when(
      str_detect(erich.whole$IT5F_SPEC, "TRACHEO") ~ "Yes",
      ))

# Variables missing: nihss.baseline, hydrocephalus, phe.volume.cc, sp.shift.baseline, intubation.days

```

**Importing and wrangling iDEF data**

```{r iDEF}

# Create function to paste together string of formXX.sas7bdat
idef.import <- function(y) {
  dataset <- paste0("idef",".",y)
  filepath <- paste0("./iDEF/form",y,".sas7bdat")
  dataset <- read_sas(filepath)
}

idefdictionary <- read_sas("iDEF/datadictionary.sas7bdat")
idef01 <- idef.import("01")
idef02 <- idef.import("02")
idef03 <- idef.import("03")
idef03c <- idef.import("03c")
idef04 <- idef.import("04")
idef05 <- idef.import("05")
idef06 <- idef.import("06")
idef07 <- idef.import("07")
idef08 <- idef.import("08")
idef10c <- idef.import("10c")
idef11 <- idef.import("11")
idef15 <- idef.import("15")
idef18 <- idef.import("18")
idef19 <- idef.import("19")
idef19c <- idef.import("19c")
idef22 <- idef.import("22")
idef23 <- idef.import("23")
idef24 <- idef.import("24")
idef25 <- idef.import("25")
idef25c <- idef.import("25c")
idef26 <- idef.import("26")
idef27 <- idef.import("27")
idef29 <- idef.import("29")
idef30 <- idef.import("30")
idef32 <- idef.import("32")
idef32c <- idef.import("32c")
idef43 <- idef.import("43")


```

**Importing and wrangling CLEAR-III data**

```{r CLEAR III}

# Importing Excel files
clear3.demographics <- readxl::read_excel("./CLEAR3/CLEAR III_Publication data_2018.1.30.xlsx", sheet = 1)
clear3.outcomes <- readxl::read_excel("./CLEAR3/CLEAR III_Publication data_2018.1.30.xlsx", sheet = 2)
clear3.180outcomes <- readxl::read_excel("./CLEAR3/CLEAR III_clinicaltrials.gov results_2018.1.30.xlsx", sheet = 1)

# Combining all dataframes into one
clear3.whole <- left_join(clear3.demographics, clear3.outcomes)
clear3.whole <- left_join(clear3.whole, clear3.180outcomes)

# Adding category to indicate study identity
clear3.whole <- clear3.whole %>% mutate(study = "CLEAR III")

# Renaming Variables

clear3.whole <- clear3.whole %>%
  rename(age = age_at_registration) %>%
  rename(sbp.initial = er_present_systolic) %>%
  rename(dbp.initial = er_present_diastolic) %>%
  rename(ich.location.baseline = adjudicated_ich_location) %>%
  rename(gcs.baseline = er_present_gcs_total) %>%
  rename(nihss.baseline = er_present_nihss_total) %>%
  rename(ich.volume.cc = dct_ich_volume_rc) %>%
  rename(ivh.volume.cc = dct_ivh_volume_rc) %>%
  rename(mrs.30 = glasgow_rankin_30) %>%
  rename(mrs.180 = glasgow_rankin_180) %>%
  rename(gose.30 = gose_30) %>%
  rename(gose.180 = gose_180) %>%
  rename(comfort.day = ictus_to_withdrawal_days)


# Categorizing and Recoding Variables

clear3.whole <- clear3.whole %>%
  mutate(ich.location.baseline = case_when(
    ich.location.baseline == "Caudate" ~ "Basal Ganglia",
    ich.location.baseline == "Frontal" ~ "Lobar",
    ich.location.baseline == "Globus Pallidus" ~ "Basal Ganglia",
    ich.location.baseline == "Occipital" ~ "Lobar",
    ich.location.baseline == "Other" ~ "NA",
    ich.location.baseline == "Probable Primary IVH" ~ "Primary IVH",
    ich.location.baseline == "Putamen" ~ "Basal Ganglia",
    ich.location.baseline == "Temporal" ~ "Lobar",
    ich.location.baseline == "Thalamus" ~ "Thalamus"
  ))

clear3.whole <- clear3.whole %>%
  mutate(race = case_when(
    race == "African-American" ~ "Black or African-American",
    race == "Asian" ~ "Asian",
    race == "Hawaiian or Pacific" ~ "Native Hawaiian/Pacific Islander",
    race == "Indian or Alaskan" ~ "American Indian or Alaskan Native",
    race == "Indian or Alaskan;White" ~ "American Indian or Alaskan Native",
    race == "unknown/missing" ~ "Other/Not Reported",
    race == "White" ~ "White"
  ))

clear3.whole <- clear3.whole %>%
  mutate(ethnicity = recode(hispanic_latino,
                            "0" = "Not Hispanic or Latino",
                            "1" = "Hispanic or Latino"
  ))

clear3.whole <- clear3.whole %>%
  mutate(sex = recode(gender,
                         "female" = "Female",
                         "male" = "Male"))

clear3.whole <- clear3.whole %>%
  mutate(ich.laterality = recode(hemisphere,
                                 "left" = "Left",
                                 "right" = "Right",
                                 "unknown/missing" = "NA" ))

clear3.whole <- clear3.whole %>%
  mutate(tobacco = recode(tobacco_use,
                          "1" = "Yes",
                          "NA" = "No"))


clear3.whole <- clear3.whole %>% mutate(ivh = "Yes")

clear3.whole <- clear3.whole %>%
  mutate(comfort.binary = case_when(
    withdrawal_contribution == "on" ~ "Yes",
    TRUE ~ "No"
  ))

# Recalculating Time to ED Presentation

clear3.whole <- clear3.whole %>%
  mutate(time.to.ed.minutes = ictus_to_presentation*24*60) %>%
  mutate(time.to.ed.hours = ictus_to_presentation*24)

clear3.whole$time.to.ed.minutes <- round(clear3.whole$time.to.ed.minutes, digits = 0)
clear3.whole$time.to.ed.hours <- round(clear3.whole$time.to.ed.hours, digits = 2)


```

**Importing and Wrangling MISTIE-II data**

```{r MISTIE II}

# Importing MISTIE II data

mistie2.demographics <- readxl::read_excel("./MISTIE2/MISTIE II_Publication results_2016.4.14_RT_RD updates 2017.10.2.xlsx", sheet = 1)

mistie2.demographics2 <- readxl::read_excel("./MISTIE2/MISTIE II and ICES_Demographics data_2017.10.16.xlsx", sheet = 1)

mistie2.results <- readxl::read_excel("./MISTIE2/MISTIE II and ICES_ctgov results_2017.10.17.xlsx", sheet = 3)

mistie2.demographics3 <- readxl::read_excel("./MISTIE2/ICES_Publication results_2015.12.23_RT_RD updates 2017.10.16.xlsx", sheet = 1)

mistie2.combined.demographics <- left_join(mistie2.demographics, mistie2.demographics3)
mistie2.combined.demographics <- left_join(mistie2.combined.demographics, mistie2.demographics2)

mistie2.wide.results <- mistie2.results %>%
  pivot_wider(names_from = Follow_up_Visit, values_from = c(GOS, eGOS_Score, rankin_score, SIS_Total, SIS_16_Total))

mistie2.whole <- full_join(mistie2.wide.results, mistie2.combined.demographics)

mistie2.whole <- mistie2.whole %>% mutate(study = "MISTIE II")

# Renaming and Recoding Variables

mistie2.whole <- mistie2.whole %>%
  mutate(ethnicity = case_when(
    Race == "African American not Hispanic" ~ "Not Hispanic or Latino",
    Race == "Hispanic" ~ "Hispanic or Latino",
    Race == "Asian or Pacific Islander" ~ "Not Hispanic or Latino",
    Race == "Caucasian not Hispanic" ~ "Not Hispanic or Latino",
    Race == "Other or unknown" ~ "Not Hispanic or Latino"
  ))

mistie2.whole <- mistie2.whole %>%
  mutate(race = recode(Race,
                       "African American not Hispanic" = "Black or African-American",
                       "Asian or Pacific Islander" = "Asian",
                       "Caucasian not Hispanic" = "White",
                       "Hispanic" = "Other/Not Reported",
                       "Other or unknown" = "Other/Not Reported"
  ))

mistie2.whole <- mistie2.whole %>%
  mutate(ich.location.baseline = case_when(
    clot_location_rc == "Globus Palidus" ~ "Basal Ganglia",
    clot_location_rc == "Lobar" ~ "Lobar",
    clot_location_rc == "Putamen" ~ "Basal Ganglia",
    clot_location_rc == "Thalamus" ~ "Thalamus"
  ))

mistie2.whole <- mistie2.whole %>%
  mutate(ivh = recode(any_ivh_prerand,
                      "1" = "Yes",
                      "0" = "No",
                      .default = "NA"
  ))



mistie2.whole <- mistie2.whole %>%
  rename(sbp.initial = er_sbp) %>%
  rename(dbp.initial = er_dbp) %>%
  rename(gcs.baseline = enrollment_gcs) %>%
  rename(nihss.baseline = enrollment_nihss_total) %>%
  rename(ich.volume.cc = pre_rand_ichvol) %>%
  rename(ivh.volume.cc = pre_rand_ivhvol) %>%
  rename(htn = Hypertension) %>%
  rename(hld = Hyperlipidemia) %>%
  rename(dm2 = Diabetes) %>%
  rename(tobacco = Tobacco_Use) %>%
  rename(cad = Other_CV) %>%
  rename(gos.365 = GOS_365) %>%
  rename(gos.270 = GOS_270) %>%
  rename(gos.180 = GOS_180) %>%
  rename(gos.90 = GOS_90) %>%
  rename(gos.30 = GOS_30) %>%
  rename(egos.365 = eGOS_Score_365) %>%
  rename(egos.270 = eGOS_Score_270) %>%
  rename(egos.180 = eGOS_Score_180) %>%
  rename(egos.90 = eGOS_Score_90) %>%
  rename(egos.30 = eGOS_Score_30) %>%
  rename(mrs.365 = rankin_score_365) %>%
  rename(mrs.270 = rankin_score_270) %>%
  rename(mrs.180 = rankin_score_180) %>%
  rename(mrs.90 = rankin_score_90) %>%
  rename(mrs.30 = rankin_score_30) %>%
  rename(ich.laterality = hemisphere)

mistie2.whole <- mistie2.whole %>%
  mutate(ich.laterality = case_when(
    ich.laterality == "Discrepancy" ~ "NA",
    ich.laterality == "Left" ~ "Left",
    ich.laterality == "Right" ~ "Right",
  ))

```

**Importing and Wrangling MISTIE-III data**

```{r MISTIE-III}

# Importing MISTIE III data
mistie3 <- read.table("./MISTIE3/Deidentified_Mistie_III_Wide_Analytic_2019_07_11 (1).csv", sep = ",", header = TRUE)

mistie3 <- mistie3 %>% mutate(study = "MISTIE III")

mistie3 <- mistie3 %>%
  rename(age = age_at_consent) %>%
  rename(race = race_ninds) %>%
  rename(sbp.initial = er_present_systolic) %>%
  rename(dbp.initial = er_present_diastolic) %>%
  rename(gcs.baseline = gcs_total) %>%
  rename(nihss.baseline = nihss_total) %>%
  rename(ich.volume.cc = diagct_ich_volume) %>%
  rename(ivh.volume.cc = diagct_ivh_volume) %>%
  rename(ich.laterality = ich_hemisphere_adj) %>%
  rename(mrs.30 = glasgow_rankin_30) %>%
  rename(mrs.180 = glasgow_rankin_180) %>%
  rename(mrs.365 = glasgow_rankin_365) %>%
  rename(barthel.total.365 = barthel_index_365) %>%
  rename(eq.vas.365 = eq_vas_365) %>%
  rename(time.to.ed.hours = ictus_to_diagct_hours)

mistie3$time.to.ed.hours = round(mistie3$time.to.ed.hours, digits = 2)
mistie3$time.to.ed.minutes = mistie3$time.to.ed.hours * 60
mistie3$time.to.ed.minutes = round(mistie3$time.to.ed.minutes, digits = 0)

mistie3 <- mistie3 %>%
  mutate(race = case_when(
    race == "African-American" ~ "Black or African-American",
    race == "Asian Hawaiian or Pacific" ~ "Asian",
    race == "Indian or Alaskan" ~ "American Indian or Alaskan Native",
    race == "More than one race" ~ "Other/Not Reported",
    race == "White" ~ "White"
  ))

mistie3 <- mistie3 %>%
  mutate(ethnicity = case_when(
         hispanic == "0" ~ "Not Hispanic or Latino",
         hispanic == "1" ~ "Hispanic or Latino"
  ))

mistie3 <- mistie3 %>%
  mutate(sex = case_when(
    male_gender == "0" ~ "Woman",
    male_gender == "1" ~ "Man"
  ))

mistie3 <- mistie3 %>%
  mutate(tobacco = case_when(
    current_smoker == "0" ~ "No",
    current_smoker == "1" ~ "Yes"
  ))

mistie3 <- mistie3 %>%
  mutate(dm2 = case_when(
    diabetes_pmh == "0" ~ "No",
    diabetes_pmh == "1" ~ "Yes"
  ))

mistie3 <- mistie3 %>%
  mutate(htn = case_when(
    htn_pmh == "0" ~ "No",
    htn_pmh == "1" ~ "Yes"
  ))

mistie3 <- mistie3 %>%
  mutate(cad = case_when(
    cvd_pmh == "0" ~ "No",
    cvd_pmh == "1" ~ "Yes"
  ))

mistie3 <- mistie3 %>%
  mutate(ich.location.baseline = case_when(
    ich_location_specify == "BG" ~ "Basal Ganglia",
    ich_location_specify == "Frontal" ~ "Lobar",
    ich_location_specify == "Occipital" ~ "Lobar",
    ich_location_specify == "Parietal" ~ "Lobar",
    ich_location_specify == "Temporal" ~ "Lobar",
    ich_location_specify == "Thalamus" ~ "Thalamus",
  ))

mistie3 <- mistie3 %>%
  mutate(comfort.binary = case_when(
    withdrawal_contribution == "0" ~ "No",
    withdrawal_contribution == "1" ~ "Yes"
  ))

mistie3 <- subset(mistie3, select = -withdrawal_contribution)

mistie3 <- mistie3 %>%
  mutate(euro.mobility.365 = case_when(
    eq5d_mobility_365 == "1" ~ "No Problems",
    eq5d_mobility_365 == "2" ~ "Some Problems",
    eq5d_mobility_365 == "3" ~ "Extreme Problems"
  ))

mistie3 <- mistie3 %>%
  mutate(euro.selfcare.365 = case_when(
    eq5d_selfcare_365 == "1" ~ "No Problems",
    eq5d_selfcare_365 == "2" ~ "Some Problems",
    eq5d_selfcare_365 == "3" ~ "Extreme Problems"
  ))

mistie3 <- mistie3 %>%
  mutate(euro.usual.365 = case_when(
    eq5d_activities_365 == "1" ~ "No Problems",
    eq5d_activities_365 == "2" ~ "Some Problems",
    eq5d_activities_365 == "3" ~ "Extreme Problems"
  ))

mistie3 <- mistie3 %>%
  mutate(euro.pain.365 = case_when(
    eq5d_pain_365 == "1" ~ "No Problems",
    eq5d_pain_365 == "2" ~ "Some Problems",
    eq5d_pain_365 == "3" ~ "Extreme Problems"
  ))

mistie3 <- mistie3 %>%
  mutate(euro.anxiety.365 = case_when(
    eq5d_anxiety_365 == "1" ~ "No Problems",
    eq5d_anxiety_365 == "2" ~ "Some Problems",
    eq5d_anxiety_365 == "3" ~ "Extreme Problems"
  ))

mistie3 <- mistie3 %>%
  mutate(current.location.30 = case_when(
    location_d30 == "Acute - Hospital" ~ "Hospital",
    location_d30 == "Acute - ICU" ~ "Hospital",
    location_d30 == "Dead" ~ "Dead",
    location_d30 == "Home" ~ "Home",
    location_d30 == "Rehab" ~ "Rehabilitation",
    location_d30 == "LTCF" ~ "Skilled Nursing Facility",
    location_d30 == "Hospice" ~ "Hospice",
  ))

mistie3 <- mistie3 %>%
  mutate(current.location.180 = case_when(
    location_d180 == "Acute - Hospital" ~ "Hospital",
    location_d180 == "Acute - ICU" ~ "Hospital",
    location_d180 == "Dead" ~ "Dead",
    location_d180 == "Home" ~ "Home",
    location_d180 == "Rehab" ~ "Rehabilitation",
    location_d180 == "LTCF" ~ "Skilled Nursing Facility",
    location_d180 == "Hospice" ~ "Hospice",
  ))

mistie3 <- mistie3 %>%
  mutate(current.location.365 = case_when(
    location_d365 == "Acute - Hospital" ~ "Hospital",
    location_d365 == "Acute - ICU" ~ "Hospital",
    location_d365 == "Dead" ~ "Dead",
    location_d365 == "Home" ~ "Home",
    location_d365 == "Rehab" ~ "Rehabilitation",
    location_d365 == "LTCF" ~ "Skilled Nursing Facility",
    location_d365 == "Hospice" ~ "Hospice",
  ))

# Calculating WLST Day

mistie3 <- mistie3 %>%
  mutate(symptom.onset.date = mdy(ninds_symptom_onset_date)) %>%
  mutate(withdrawal.date = mdy(ninds_withdrawal_date))

mistie3$withdrawal.interval <- as.period(mistie3$symptom.onset.date %--% mistie3$withdrawal.date)
mistie3$withdrawal.interval <- time_length(mistie3$withdrawal.interval, unit = "days")
mistie3$comfort.day <- round(mistie3$withdrawal.interval, digits = 0)



```


**Combining Datasets**

```{r Combining Everything}

# Combining Data from All Studies
combined.dataset.list <- list(atach.whole, erich.whole, clear3.whole, mistie2.whole, mistie3)

atach.erich <- full_join(atach.whole, erich.whole)
atach.erich.clear <- full_join(atach.erich, clear3.whole)
atach.erich.clear.mistie2 <- full_join(atach.erich.clear, mistie2.whole)
atach.erich.clear.mistie2.mistie3 <- full_join(atach.erich.clear.mistie2, mistie3)

VarsTableOne <- c("study","age", "sex", "ethnicity", # Ethnicity
                       "race", # Race
                       "enrolling.country", # Country of Enrolling Site
                       "stroke", 
                       "cad", 
                       "chf", 
                       "afib", 
                       "htn",
                       "hld",
                       "dm2",
                       "tobacco",
                       "time.to.ed.minutes", # Time from symptom onset to Ed presentation
                       "sbp.initial", # Initial SBP
                       "dbp.initial", # Initial DBP
                       "gcs.baseline", # Baseline GCS
                       "nihss.baseline", # NIHSS
                       "ich.location.baseline", 
                       "ivh",
                      # "hydrocephalus",
                       "ich.volume.cc",
                       "ivh.volume.cc",
                       "phe.volume.cc",
                       "sp.shift.baseline",
                       "mech.ventilation",
                       "intubation.days", 
                       "extubation.date", # Date of extubation
                       "tracheostomy",
                       "trach.date", # Date of Tracheostomy
                       "evd",
                       "evd.days", # Total EVD days
                       "nsgy.evacuation",
                       "nsgy.evacuation.date",  # Date of Evacuation
                       "mrs.30",
                       "mrs.90",
                      "mrs.180",
                      "mrs.365",
                      "euro.mobility.90",
                      "euro.mobility.180",
                      "euro.mobility.365",
                       "euro.selfcare.90",
                      "euro.selfcare.180",
                      "euro.selfcare.365",
                       "euro.usual.90",
                      "euro.usual.180",
                      "euro.usual.365",
                       "euro.pain.90",
                      "euro.pain.180",
                      "euro.pain.365",
                       "euro.anxiety.90",
                      "euro.anxiety.180",
                      "euro.anxiety.365",
                       "euro.vas.90", # EuroQOL VAS
                       "euro.vas.180",
                       "euro.vas.365",
                       "EQ_INDEX.90", # EQ-5D Utility Index,,
                      "current.location.90",
                      "current.location.180",
                      "current.location.365",
                       "ich.laterality",
                  "dnr.binary",
                  "comfort.binary",
                  "dnr.day",
                  "comfort.day"
                  )

ninds.combined <- atach.erich.clear.mistie2.mistie3 %>%
  select(VarsTableOne)

ninds.combined <- ninds.combined %>%
  mutate(ich.score.age = case_when(
    age < 80 ~ 0,
    age >= 80 ~ 1
  )) %>%
  mutate(ich.score.gcs = case_when(
    gcs.baseline >= 13 ~ 0,
    gcs.baseline <= 4 ~ 2,
    TRUE ~ 1)) %>%
  mutate(ich.score.volume = if_else(ich.volume.cc >= 30,1,0)) %>%
  mutate(ich.score.ivh = if_else(ivh == "Yes",1,0)) %>%
  mutate(ich.score.total = ich.score.age + 
                           ich.score.gcs + 
                           ich.score.volume +
                           ich.score.ivh)

# Cleaning up combined dataset
ninds.combined <- ninds.combined %>%
  mutate(sex = case_when(
    sex == "Man" ~ "Male",
    sex == "Male" ~ "Male",
    sex == "Woman" ~ "Female",
    sex == "Female" ~ "Female")) %>%
  mutate(ethnicity = case_when(
    ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
    ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino",
    ethnicity == "Unknown/Not Reported" ~ "NA")) 
ninds.combined <- ninds.combined %>%
  filter(ich.location.baseline == "Lobar" | 
           ich.location.baseline == "Thalamus" |
           ich.location.baseline == "Basal Ganglia") %>%
  mutate(ich.laterality = na_if(ich.laterality, "NA")) %>%
  mutate(ethnicity = na_if(ethnicity, "NA")) %>%
  mutate(stroke = na_if(stroke, "NA")) %>%
  mutate(cad = na_if(cad, "NA")) %>%
  mutate(chf = na_if(chf, "NA")) %>%
  mutate(afib = na_if(afib, "NA")) %>%
  mutate(htn = na_if(htn, "NA")) %>%
  mutate(hld = na_if(hld, "NA")) %>%
  mutate(dm2 = na_if(dm2, "NA")) %>%
  mutate(tobacco = na_if(tobacco, "NA")) %>%
  mutate(euro.mobility.90 = na_if(euro.mobility.90, "NA")) %>%
  mutate(euro.selfcare.90 = na_if(euro.selfcare.90, "NA")) %>%
  mutate(euro.usual.90 = na_if(euro.usual.90, "NA")) %>%
  mutate(euro.pain.90 = na_if(euro.pain.90, "NA")) %>%
  mutate(euro.anxiety.90 = na_if(euro.anxiety.90, "NA")) %>%
  mutate(dnr.binary = na_if(dnr.binary, "NA")) %>%
  mutate(comfort.binary = na_if(comfort.binary, "NA")) %>%
  filter(!is.na(ich.laterality))

ninds.combined$comfort.day <- round(ninds.combined$comfort.day)

table1 <- CreateTableOne(data = ninds.combined,
                         strata = "ich.laterality")

```

```{r output = TRUE}
print(table1, showAllLevels = FALSE)

```

```{r output = TRUE}

write.csv(ninds.combined, file = "nindsCombined.csv")


```