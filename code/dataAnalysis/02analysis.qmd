---
title: "Hemispheric Lateralization in ICH"
subtitle: "Analysis"
author: "Nikhil Patel"
project:
  type: default
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
    html-math-method: katex
    css: "styles.css"
    fig-width: 12
---


```{r setup and data import}
#| output: false

library(tidyverse)
# library(gt) # Fancy tables
library(tableone)
library(data.table)
library(haven) # Importing SAS Files
library(janitor)
library(lubridate)
library(readxl)
library(Hmisc)
library(stringr)
library(qs)
library(glue)
library(scales) # Nicer labeling functions
library(ggmosaic) # Mosaic plots with ggplot
library(ggplot2)
library(ggpattern) # Pattern fills in ggplot
library(patchwork) # Combine plots nicely
library(systemfonts) ## use custom fonts (need to be installed on your OS)
library(scico) ## scico color palettes(http://www.fabiocrameri.ch/colourmaps.php) in R
library(ggtext) ## add improved text rendering to ggplot2
library(ggforce) ## add missing functionality to ggplot2
library(ggdist) ## add uncertainity visualizations to ggplot2
library(viridis)
library(dagitty)

d <- qread("../../data/nindsCombined.qs")

```

## Causal Question
**Does the hemispheric location of an intracerebral hemorrhage (ICH) influence outcomes such as death, disability, or health-related quality of life?**

Clinical manifestations of brain injury differ between left and right hemispheric lesions because of differences in function, in particular language and spatial awareness.

It is unclear if these clinical differences result in differences in functional disability or health-related quality of life. Previous studies have demonstrated conflicting results, with some demonstrating worse levels of disability for patients with left hemispheric lesions as well as the opposite.

We aim to evaluate the question of if patients with left-hemispheric lesions have worse levels of disability or health-related quality of life.

### Data Source

We used individual patient data from 5 NINDS multicenter prospective studies enrolling patients with intracerebral hemorrhage (4 randomized trials: ATACH2, CLEAR3, MISTIE-II, and MISTIE-III and 1 observational study: ERICH).

### Visualizing the Data

Comparing outcomes between left and right hemisphere location overall. There does not appear to be a big difference.

```{r}

mrsCounts <- d |>
  filter(!is.na(mrs90)) |>
  group_by(ichLaterality, mrs90) |>
  tally(name = "patients") |>
  group_by(ichLaterality) |>
  mutate(percentPatients = patients / sum(patients)) |>
  ungroup() |>
  mutate(percentPatientsLabel = percent(percentPatients, accuracy = 1))

theme_set(theme_minimal(base_size = 20, base_family = "Figtree"))

myColors <- c("#ffbe63", "#f39264", "#d76c6a", "#ae4f6e", "#7c3c6b", "#462d5d", "#0a1e45") # https://learnui.design/tools/data-color-picker.html#palette

ggplot(
  data = mrsCounts,
  aes(x = ichLaterality, y = percentPatients, fill = forcats::fct_rev(mrs90))
) +
  geom_bar(stat = "identity", position = "fill", width = 0.5) +
  geom_text(aes(label = patients),
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 5,
    family = "FigTree"
  ) +
  coord_flip() +
  scale_y_continuous(
    name = NULL,
    labels = scales::percent_format(accuracy = 1),
    breaks = c(seq(0, 1, 0.2))
  ) +
  scale_x_discrete(name = NULL) +
  scale_fill_manual(values = myColors, breaks = c(0, 1, 2, 3, 4, 5, 6)) +
  labs(
    title = "Hemispheric Laterality",
    subtitle = "modified Rankin score at 90 days"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 30, lineheight = 0.1),
    plot.subtitle = element_text(size = 20, lineheight = 0.1),
    plot.caption = element_text(size = 20),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    legend.title = element_blank(),
    legend.position = "right",
    legend.text = element_text(size = 15, lineheight = 0.5),
    # legend.margin = margin(r = 50),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.y = element_text(size = 20, lineheight = 0.5, margin = margin(r = -10)),
    axis.title.x = element_text(size = 20, lineheight = 0.5)
  )

```

```{r}

mrsCounts <- d |>
  filter(!is.na(mrs180)) |>
  group_by(ichLaterality, mrs180) |>
  tally(name = "patients") |>
  group_by(ichLaterality) |>
  mutate(percentPatients = patients / sum(patients)) |>
  ungroup() |>
  mutate(percentPatientsLabel = percent(percentPatients, accuracy = 1))

theme_set(theme_minimal(base_size = 20, base_family = "Figtree"))

myColors <- c("#ffbe63", "#f39264", "#d76c6a", "#ae4f6e", "#7c3c6b", "#462d5d", "#0a1e45") # https://learnui.design/tools/data-color-picker.html#palette

ggplot(
  data = mrsCounts,
  aes(x = ichLaterality, y = percentPatients, fill = forcats::fct_rev(mrs180))
) +
  geom_bar(stat = "identity", position = "fill", width = 0.5) +
  geom_text(aes(label = patients),
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 5,
    family = "FigTree"
  ) +
  coord_flip() +
  scale_y_continuous(
    name = NULL,
    labels = scales::percent_format(accuracy = 1),
    breaks = c(seq(0, 1, 0.2))
  ) +
  scale_x_discrete(name = NULL) +
  scale_fill_manual(values = myColors, breaks = c(0, 1, 2, 3, 4, 5, 6)) +
  labs(
    title = "Hemispheric Laterality",
    subtitle = "modified Rankin score at 180 days"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 30, lineheight = 0.1),
    plot.subtitle = element_text(size = 20, lineheight = 0.1),
    plot.caption = element_text(size = 20),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    legend.title = element_blank(),
    legend.position = "right",
    legend.text = element_text(size = 15, lineheight = 0.5),
    # legend.margin = margin(r = 50),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.y = element_text(size = 20, lineheight = 0.5, margin = margin(r = -10)),
    axis.title.x = element_text(size = 20, lineheight = 0.5)
  )

```

```{r}

mrsCounts <- d |>
  filter(!is.na(mrs365)) |>
  group_by(ichLaterality, mrs365) |>
  tally(name = "patients") |>
  group_by(ichLaterality) |>
  mutate(percentPatients = patients / sum(patients)) |>
  ungroup() |>
  mutate(percentPatientsLabel = percent(percentPatients, accuracy = 1))

theme_set(theme_minimal(base_size = 20, base_family = "Figtree"))

myColors <- c("#ffbe63", "#f39264", "#d76c6a", "#ae4f6e", "#7c3c6b", "#462d5d", "#0a1e45") # https://learnui.design/tools/data-color-picker.html#palette

ggplot(
  data = mrsCounts,
  aes(x = ichLaterality, y = percentPatients, fill = forcats::fct_rev(mrs365))
) +
  geom_bar(stat = "identity", position = "fill", width = 0.5) +
  geom_text(aes(label = patients),
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 5,
    family = "FigTree"
  ) +
  coord_flip() +
  scale_y_continuous(
    name = NULL,
    labels = scales::percent_format(accuracy = 1),
    breaks = c(seq(0, 1, 0.2))
  ) +
  scale_x_discrete(name = NULL) +
  scale_fill_manual(values = myColors, breaks = c(0, 1, 2, 3, 4, 5, 6)) +
  labs(
    title = "Hemispheric Laterality",
    subtitle = "modified Rankin score at 365 days"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 30, lineheight = 0.1),
    plot.subtitle = element_text(size = 20, lineheight = 0.1),
    plot.caption = element_text(size = 20),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    legend.title = element_blank(),
    legend.position = "right",
    legend.text = element_text(size = 15, lineheight = 0.5),
    # legend.margin = margin(r = 50),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.y = element_text(size = 20, lineheight = 0.5, margin = margin(r = -10)),
    axis.title.x = element_text(size = 20, lineheight = 0.5)
  )

```

```{r}

euroQOLCounts <- d |>
  filter(!is.na(euroMobility90)) |>
  group_by(ichLaterality, euroMobility90) |>
  tally(name = "patients") |>
  group_by(ichLaterality) |>
  mutate(percentPatients = patients / sum(patients)) |>
  ungroup() |>
  mutate(percentPatientsLabel = percent(percentPatients, accuracy = 1))

theme_set(theme_minimal(base_size = 20, base_family = "Figtree"))

myColors <- c("#ffbe63", "#f39264", "#d76c6a", "#ae4f6e", "#7c3c6b", "#462d5d", "#0a1e45") # https://learnui.design/tools/data-color-picker.html#palette

ggplot(
  data = euroQOLCounts,
  aes(x = ichLaterality, y = percentPatients, fill = euroMobility90)
) +
  geom_bar(stat = "identity", position = "fill", width = 0.5) +
  geom_text(aes(label = patients),
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 5,
    family = "FigTree"
  ) +
  coord_flip() +
  scale_y_continuous(
    name = NULL,
    labels = scales::percent_format(accuracy = 1),
    breaks = c(seq(0, 1, 0.2))
  ) +
  scale_x_discrete(name = NULL) +
  # scale_fill_viridus_c() +
  labs(
    title = "Hemispheric Laterality",
    subtitle = "euroMobility90"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 30, lineheight = 0.1),
    plot.subtitle = element_text(size = 20, lineheight = 0.1),
    plot.caption = element_text(size = 20),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    legend.title = element_blank(),
    legend.position = "right",
    legend.text = element_text(size = 15, lineheight = 0.5),
    # legend.margin = margin(r = 50),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text.y = element_text(size = 20, lineheight = 0.5, margin = margin(r = -10)),
    axis.title.x = element_text(size = 20, lineheight = 0.5)
  )


```

## Draw Assumptions using a Causal Diagram

```{r}

dag {
bb="0,0,1,1"
"Disease Severity" [adjusted,pos="0.152,0.791"]
"Early WLST" [adjusted,pos="0.326,0.215"]
"Functional Outcome" [outcome,pos="0.916,0.455"]
"ICH Laterality" [exposure,pos="0.070,0.455"]
Age [adjusted,pos="0.253,0.858"]
Comorbidities [adjusted,pos="0.380,0.903"]
Neurosurgery [adjusted,pos="0.736,0.148"]
Rehabilitation [latent,pos="0.849,0.703"]
"Disease Severity" -> "Early WLST"
"Disease Severity" -> "Functional Outcome"
"Disease Severity" -> Neurosurgery
"Disease Severity" -> Rehabilitation
"Early WLST" -> "Functional Outcome"
"ICH Laterality" -> "Early WLST"
"ICH Laterality" -> "Functional Outcome"
"ICH Laterality" -> Neurosurgery
Age -> "Functional Outcome"
Age -> Neurosurgery
Age -> Rehabilitation
Comorbidities -> "Functional Outcome"
Comorbidities -> Neurosurgery
Comorbidities -> Rehabilitation
Neurosurgery -> "Functional Outcome"
Rehabilitation -> "Functional Outcome"
}

```

## Model Assumptions

## Diagnose Models

## Estimate the Causal Effect

## Conduct Sensitivity Analysis on the Effect Estimate

#
#
#
#
#
#
#
#
#
#
#
#
#
#
#
#
