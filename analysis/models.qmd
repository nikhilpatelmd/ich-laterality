---
title: "Models"
code-fold: true
---

```{r setup, warning=FALSE, message=FALSE}

library(tidyverse)
library(ordinal)
library(marginaleffects)
library(modelsummary)
library(brms)
library(cmdstanr)
library(tidybayes)
library(broom.mixed)
library(ggplot2)
library(ggdist)
library(broom)
library(gt)
library(here)

options(mc.cores = parallel::detectCores())

data <- read_rds(here("data", "all.rds"), refhook = NULL)

data <- data |>
  filter(ich_location == "Basal Ganglia" | ich_location == "Thalamus" | ich_location == "Lobar")

data$ich_location <- fct_drop(data$ich_location)
table(data$ich_location)

# plot stuff
theme_set(theme_minimal(base_family = "Cantarell"))

```

## Visualization


```{r interact2 analysis replication}

mrs_prop <- data |>
  count(mrs_90) |>
  mutate(p = n / sum(n), cumsum_p = cumsum(p)) |>
  na.omit()

mrs_prop |>
  ggplot(aes(x = mrs_90, y = p)) +
  geom_col(fill = "coral") +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "mRS 90", y = "Proportion")

mrs_prop |>
  ggplot(aes(x = as.integer(mrs_90), y = cumsum_p)) +
  geom_point(size = 2) +
  geom_line(linewidth = 1) +
  labs(x = "mRS 90", y = "Cumulative Proportion")

mrs_prop |>
  ggplot(aes(x = as.integer(mrs_90), y = log(cumsum_p) - log(1 - cumsum_p))) +
  geom_point(size = 2) +
  geom_line(linewidth = 1) +
  labs(x = "mRS 90", y = "Logit Cumulative Proportion")


```

## Frequentist Analysis

### Mediation Analysis with Neurosurgery and ICH Laterality

```{r frequentist ordinal}

fit_freq <- clm(
  mrs_90 ~ ich_laterality + age + ich_location + ich_volume_baseline + gcs_baseline + neurosurgery_evac,
  data = data,
  link = "logit"
)

summary(fit_freq)

predictions(fit_freq, by = "ich_laterality", type = "cum.prob") |>
  gt()

predictions(fit_freq, by = c("ich_location", "ich_laterality"), type = "cum.prob") |>
  gt()

plot_predictions(fit_freq, condition = c("ich_location", "ich_laterality"), type = "cum.prob")

tidy(fit_freq)

```

## Bayesian Analysis

```{r bayesian ordinal, warning=FALSE, message=FALSE}

fit_brms <- brm(
  mrs_90 ~ ich_laterality + age + ich_location + ich_volume_baseline + gcs_baseline + neurosurgery_evac,
  data = data,
  family = cumulative(logit),
  prior = set_prior("normal(0,5)"),
  chains = 2,
  cores = 6,
  backend = "cmdstanr"
)

print(fit_brms)

predictions(fit_brms, by = c("ich_location", "ich_laterality"), type = "response") |>
  gt()

plot_predictions(fit_brms, condition = c("ich_location", "ich_laterality"), type = "response")


```

