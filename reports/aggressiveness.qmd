---
title: Differences in care for patients experiencing left vs. right hemisphere ICH
author: Nikhil Patel, MD
format:
  html: 
    mainfont: Figtree
    monofont: Source Code Pro
    fontsize: 0.97rem
    embed-resources: true
    toc: true
    toc-location: left
    toc-depth: 6
    toc-expand: true
    toc-title: Contents
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    code-overflow: wrap
    code-tools: true
    code-fold: true
    highlight-style: nord
---

::: {.callout-note icon="false"}
## Research question

Do patients presenting with left hemispheric ICH receive less aggressive care (as measured by rates of neurosurgery, ventriculostomy, tracheostomy, PEG, and early withdrawal of life-sustaining therapies) as compared to those with right hemispheric ICH?

:::


```{r setup, output=FALSE, message=FALSE, warning=FALSE}
library(targets)
library(skimr)
library(dplyr)
library(gt)
library(gtsummary)
library(ggplot2)
library(ggdag)
library(dagitty)
library(marginaleffects)
library(modelsummary)
library(MetBrewer)

# theme customization
theme_set(theme_minimal(base_family = "Figtree"))

theme_set(
  theme_dag(base_family = "Figtree") %+replace%
    # also add some additional styling
    theme(
      legend.position = "bottom",
      strip.text.x = element_text(margin = margin(2, 0, 2, 0, "mm"))
    )
)

status_colors <- c(exposure = "#CE4441", outcome = "#004F63", latent = "grey80")

# load all targets objects
tar_load_everything()

```

## Exploratory Data Analysis

### Data Overview

::: {.callout-warning title="Issues to Address"}
`htn` is missing mostly all information. It is also listed as a character variable.

All other co-morbidities are missing information; if this is the case, should default to "No".

`ivh` is also missing some values, which should also default to "No"?

Any "Yes/No" variable should not have any missing information, should just default to "No"

Verify accuracy/validity of `time_symptoms_to_ed`, `sbp_baseline`, 

Fix/drop unused levels in `race`, and fix "American Indian"

Fix "unknown" category in `ethnicity` to "Not Hispanic or Latino"

Fix/drop unused levels in `ich_location` and `study`
:::

```{r}

glimpse(non_surgery_trials)
skim(non_surgery_trials)

```


### Table 1

::: {.callout-warning title="Issues to Address"}

Collapse unused levels in `race`, `ethnicity`, `ich_location` and `study`

Change order of the displayed factors to frequency 

:::


```{r}

table_1_non_surgery

```

### Relationships between Variables

::: {.callout-important title="Other Considerations"}

Need to point out in table that `days_mechanical_ventilation` is only available in ATACH2 data. Have to clarify if `tracheostomy` and `peg` are included in ATACH2 (def included in ERICH)

:::

```{r}
#| fig-align: center

table_2_non_surgery

```

## Statistical Models

::: {.callout-important title="Other Considerations"}

Add analyses stratifying by each study: `ERICH` and `ATACH2`

Construct DAGs for **each** outcome (e.g., each model)!

Add `DNR` in addition to `comfort_care` in first analysis? 

:::


We aim to estimate the **total causal effect of hemispheric laterality in intracerebral hemorrhage on the probability of receiving aggressive interventions**, as defined by the following:

* `neurosurgery_evac`: logistic
* `ventriculostomy`: logistic
* `days_mechanical_ventilation`: poisson (cumulative logit?)
* `tracheostomy`: logistic
* `peg`: logistic
* `comfort_care`: logistic (days to comfort care, time to event?)

The directed acyclic graph (DAG) is described below. 

::: {.callout-warning title="Issues to Address"}

* Make it easier to [read](https://github.com/sakeefkarim/intro_ggdag_script/blob/main/code/code_intro_ggdag.R)! 

* Add any connections? Ask Nick, Matt, and others

* Add transparency to colors to be able to see arrows

* Fix position of arrows

* Include `symptom_onset_to_ED` in the DAG (this is known to differ in patients with ischemic stroke)

:::

### DAG

```{r aggressive dag}
#| fig-align: center
#| fig.height: 9

aggressive_dag |>
  tidy_dagitty() |>
  node_status() |>
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_point(aes(color = status)) +
  geom_dag_edges() +
  geom_dag_label_repel(aes(label = label, fill = status),
    seed = 51,
    color = "white", fontface = "bold", size = 4.5
  ) +
  scale_color_manual(values = status_colors, na.value = "grey20") +
  scale_fill_manual(values = status_colors, na.value = "grey20")

```

#### DAG-Implied Adjustment Sets

Since there is no variable that affects `hemispheric_laterality` in the DAG, the minimally sufficient adjustment set does not include any variables for the estimand of interest (total effect of `hemispheric_laterality`).

The canonical adjustment set includes `age`, `gcs_baseline`, `ich_location`, `ich_volume`, `ivh`, and `stroke`.

We include the competing exposures in the canonical adjustment set (e.g., `age`, `gcs_baseline`, `ich_location`, `ich_volume`, `ivh`, and `stroke`) as covariates in our final model to increase precision, and also run the minimal adjustment set as a sensitivity analysis.

```{r aggressive dag adjustment sets}
#| code-fold: false
#| fig-align: center
#| fig.height: 9

adjustmentSets(
  aggressive_dag,
  type = "minimal",
  effect = "total",
  max.results = Inf
)

adjustmentSets(
  aggressive_dag,
  type = "canonical",
  effect = "total",
  max.results = Inf
)

```

### Priors



### Posterior Simulation

### Analysis
