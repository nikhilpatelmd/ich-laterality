---
title: Differences in care for patients experiencing left vs. right hemisphere ICH
author: Nikhil Patel, MD
format:
  html: 
    mainfont: Figtree
    monofont: Source Code Pro
    fontsize: 0.97rem
    embed-resources: false
    toc: true
    toc-location: left
    toc-depth: 6
    toc-expand: true
    toc-title: Contents
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    code-overflow: wrap
    code-tools: true
    highlight-style: nord
---

::: {.callout-note icon="false"}
## Research question

Do patients presenting with left hemispheric ICH receive less aggressive care (as measured by rates of neurosurgery, ventriculostomy, tracheostomy, PEG, and early withdrawal of life-sustaining therapies) as compared to those with right hemispheric ICH?

:::


```{r setup, output=FALSE, message=FALSE, warning=FALSE}
library(targets)
library(skimr)
library(dplyr)
library(gt)
library(gtsummary)
library(ggplot2)
library(ggdag)
library(dagitty)
library(marginaleffects)
library(modelsummary)
library(MetBrewer)

# theme customization
theme_set(theme_minimal(base_family = "Figtree"))

theme_set(
  theme_dag(base_family = "Figtree") %+replace%
    # also add some additional styling
    theme(
      legend.position = "bottom",
      strip.text.x = element_text(margin = margin(2, 0, 2, 0, "mm"))
    )
)

status_colors <- c(exposure = "#CE4441", outcome = "#004F63", latent = "grey80")

# load all targets objects
tar_load_everything()
tar_load(ich)
tar_load(non_surgery_trials)
tar_load(surgery_trials)
tar_load(table_1)
tar_load(table_2)
tar_load(aggressive_dag)

```

## Exploratory Data Analysis

### Data Overview

::: {.callout-warning title="Issues to Address"}
`htn` is missing mostly all information. It is also listed as a character variable.

All other co-morbidities are missing information; if this is the case, should default to "No".

`ivh` is also missing some values, which should also default to "No"?

Any "Yes/No" variable should not have any missing information, should just default to "No"

Verify accuracy/validity of `time_symptoms_to_ed`, `sbp_baseline`, 

Fix/drop unused levels in `race`, and fix "American Indian"

Fix "unknown" category in `ethnicity` to "Not Hispanic or Latino"

Fix/drop unused levels in `ich_location` and `study`
:::

```{r}

glimpse(non_surgery_trials)
skim(non_surgery_trials)

```


### Table 1

::: {.callout-warning title="Issues to Address"}

Collapse unused levels in `race`, `ethnicity`, `ich_location` and `study`

Change order of the displayed factors to frequency 

:::


```{r}

table_1

```

### Relationships between Variables



```{r}
#| fig-align: center

table_2

```

## Statistical Models

::: {.callout-important title="Other Considerations"}

Add analyses stratifying by each study: `ERICH` and `ATACH2`

Construct DAGs for **each** outcome (e.g., each model)!

Add `DNR` in addition to `comfort_care`?

:::

* `neurosurgery_evac`: logistic
* `ventriculostomy`: logistic
* `days_mechanical_ventilation`: poisson (cumulative logit?)
* `tracheostomy`: logistic
* `comfort_care`: logistic (days to comfort care, time to event?)

### DAGs

#### Aggressive Care

We aim to estimate the **total causal effect of hemispheric laterality in intracerebral hemorrhage on the probability of receiving aggressive interventions**, as defined by the following:

- neurosurgery
- ventriculostomy
- tracheostomy
- PEG placement
- early withdrawal of life-sustaining therapies (< 72 hours from presentation)

::: {.callout-warning title="Issues to Address"}

* Make sure other people think it's easy to read

* Add any connections? Ask Nick, Matt, and others

* Add transparency to colors to be able to see arrows

* Fix position of arrows

:::

```{r dags}
#| fig-align: center
#| fig.height: 9


aggressive_dag |>
  tidy_dagitty() |>
  node_status() |>
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_point(aes(color = status)) +
  geom_dag_edges_diagonal() +
  geom_dag_label_repel(aes(label = label, fill = status),
    seed = 2,
    color = "white", fontface = "bold", size = 4
  ) +
  scale_color_manual(values = status_colors, na.value = "grey20") +
  scale_fill_manual(values = status_colors, na.value = "grey20")

```

