---
title: Differences in care for patients experiencing left vs. right hemisphere ICH
author: Nikhil Patel, MD
format:
  html: 
    mainfont: Figtree
    monofont: Source Code Pro
    fontsize: 0.97rem
    embed-resources: true
    toc: true
    toc-location: left
    toc-depth: 6
    toc-expand: true
    toc-title: Contents
    smooth-scroll: true
    link-external-icon: true
    link-external-newwindow: true
    code-overflow: wrap
    code-tools: true
    code-fold: true
    highlight-style: nord
---

::: {.callout-note icon="false"}
## Research question

Do patients presenting with left hemispheric ICH receive less aggressive care (as measured by rates of neurosurgery, ventriculostomy, tracheostomy, PEG, and early withdrawal of life-sustaining therapies) as compared to those with right hemispheric ICH?

:::


```{r setup, output=FALSE, message=FALSE, warning=FALSE}
library(targets)
library(skimr)
library(dplyr)
library(gt)
library(gtsummary)
library(ggplot2)
library(ggdist)
library(gghalves)
library(ggdag)
library(scales)
library(dagitty)
library(marginaleffects)
library(modelsummary)

# theme customization
theme_set(theme_minimal(base_family = "Figtree"))

theme_set(
  theme_dag(base_family = "Figtree") %+replace%
    # also add some additional styling
    theme(
      legend.position = "bottom",
      strip.text.x = element_text(margin = margin(2, 0, 2, 0, "mm"))
    )
)

status_colors <- c(exposure = "#CE4441", outcome = "#004F63", latent = "grey80")

# load all targets objects
# tar_load_everything()
tar_load(ich_aggressive)
tar_load(table_1_aggressive)
tar_load(table_2_aggressive)
tar_load(dag_aggressive)

```

## Exploratory Data Analysis

### Data Overview

::: {.callout-warning title="Issues to Address"}

Verify accuracy/validity of `time_symptoms_to_ed`, `sbp_baseline`, 

:::

```{r}

glimpse(ich_aggressive)
skim(ich_aggressive)

```


### Table 1

::: {.callout-warning title="Issues to Address"}

Collapse unused levels in `race`, `ethnicity`, `ich_location` and `study`

Change order of the displayed factors to frequency 

:::


```{r}

table_1_aggressive

```

### Relationships between Variables

::: {.callout-important title="Other Considerations"}

Need to point out in table that `days_mechanical_ventilation` is only available in ATACH2 data. Have to clarify if `tracheostomy` and `peg` are included in ATACH2 (def included in ERICH)

:::

```{r}
#| fig-align: center

table_2_aggressive

```

## Statistical Models

::: {.callout-important title="Other Considerations"}

Add analyses stratifying by each study: `ERICH` and `ATACH2`

Construct DAGs for **each** outcome (e.g., each model)!

Add `DNR` in addition to `comfort_care` in first analysis? 

:::

We aim to estimate the **total causal effect of hemispheric laterality in intracerebral hemorrhage on the probability of receiving aggressive interventions**, as defined by the following:

* `neurosurgery_evac`: logistic
* `ventriculostomy`: logistic
* `days_mechanical_ventilation`: poisson (cumulative logit?)
* `tracheostomy`: logistic
* `peg`: logistic
* `comfort_care`: logistic (days to comfort care, time to event?)

The directed acyclic graph (DAG) is described below. 

::: {.callout-warning title="Issues to Address"}

* Make it easier to [read](https://github.com/sakeefkarim/intro_ggdag_script/blob/main/code/code_intro_ggdag.R)! 

* Add any connections? Ask Nick, Matt, and others

* Add transparency to colors to be able to see arrows

* Fix position of arrows

* Include `symptom_onset_to_ED` in the DAG (this is known to differ in patients with ischemic stroke)

:::

### DAG

```{r aggressive dag}
#| fig-align: center
#| fig.height: 9

dag_aggressive |>
  tidy_dagitty() |>
  node_status() |>
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_point(aes(color = status)) +
  geom_dag_edges() +
  geom_dag_label_repel(aes(label = label, fill = status),
    seed = 51,
    color = "white", fontface = "bold", size = 4.5
  ) +
  scale_color_manual(values = status_colors, na.value = "grey20") +
  scale_fill_manual(values = status_colors, na.value = "grey20")

```

#### DAG-Implied Adjustment Sets

Since there is no variable that affects `hemispheric_laterality` in the DAG, the minimally sufficient adjustment set does not include any variables for the estimand of interest (total effect of `hemispheric_laterality`).

The canonical adjustment set includes `age`, `gcs_baseline`, `ich_location`, `ich_volume`, `ivh`, and `stroke`.

We include the competing exposures in the canonical adjustment set (e.g., `age`, `gcs_baseline`, `ich_location`, `ich_volume`, `ivh`, and `stroke`) as covariates in our final model to increase precision, and also run the minimal adjustment set as a sensitivity analysis.

```{r aggressive dag adjustment sets}
#| code-fold: false
#| fig-align: center
#| fig.height: 9

adjustmentSets(
  aggressive_dag,
  type = "minimal",
  effect = "total",
  max.results = Inf
)

adjustmentSets(
  aggressive_dag,
  type = "canonical",
  effect = "total",
  max.results = Inf
)

```

### Neurosurgical Intervention

There are two models we will run here: 1) the minimally-sufficient adjustment model, 2) the canonical adjustment model

#### Model

```{r}

tar_load(neurosurgery_evac_min)

predictions(neurosurgery_evac_min, by = "ich_laterality")

plot_predictions(neurosurgery_evac_min, condition = "ich_laterality") +
  labs(x = "ICH Laterality", y = "Probability of Neurosurgery")

# Format things as percentage points
label_pp <- label_number(
  accuracy = 1, scale = 100,
  suffix = " pp.", style_negative = "minus"
)

label_pp_tiny <- label_number(
  accuracy = 0.01, scale = 100,
  suffix = " pp.", style_negative = "minus"
)

theme_clean <- function() {
  theme_minimal(base_family = "Barlow Semi Condensed") +
    theme(
      panel.grid.minor = element_blank(),
      plot.title = element_text(family = "BarlowSemiCondensed-Bold"),
      axis.title = element_text(family = "BarlowSemiCondensed-Medium"),
      strip.text = element_text(
        family = "BarlowSemiCondensed-Bold",
        size = rel(1), hjust = 0
      ),
      strip.background = element_rect(fill = "grey80", color = NA)
    )
}

avg_comparisons(neurosurgery_evac_min, variables = "ich_laterality") |>
  posterior_draws() |>
  ggplot(aes(x = draw)) +
  stat_halfeye(
    .width = c(0.8, 0.95), point_interval = "median_hdi",
    fill = "#bc3032"
  ) +
  scale_x_continuous(labels = label_pp) +
  labs(
    x = "Effect of hemispheric laterality\n on the probability of receiving neurosurgical intervention",
    y = NULL, caption = "80% and 95% credible intervals shown in black"
  ) +
  theme_clean()

```

```{r canonical}
tar_load(neurosurgery_evac_can)

predictions(neurosurgery_evac_can, by = "ich_laterality")

plot_predictions(neurosurgery_evac_can, condition = "ich_laterality") +
  labs(x = "ICH Laterality", y = "Probability of Neurosurgery")

# Format things as percentage points
label_pp <- label_number(
  accuracy = 1, scale = 100,
  suffix = " pp.", style_negative = "minus"
)

label_pp_tiny <- label_number(
  accuracy = 0.01, scale = 100,
  suffix = " pp.", style_negative = "minus"
)

theme_clean <- function() {
  theme_minimal(base_family = "Barlow Semi Condensed") +
    theme(
      panel.grid.minor = element_blank(),
      plot.title = element_text(family = "BarlowSemiCondensed-Bold"),
      axis.title = element_text(family = "BarlowSemiCondensed-Medium"),
      strip.text = element_text(
        family = "BarlowSemiCondensed-Bold",
        size = rel(1), hjust = 0
      ),
      strip.background = element_rect(fill = "grey80", color = NA)
    )
}

avg_comparisons(neurosurgery_evac_can, variables = "ich_laterality") |>
  posterior_draws() |>
  ggplot(aes(x = draw)) +
  stat_halfeye(
    .width = c(0.8, 0.95), point_interval = "median_hdi",
    fill = "#bc3032"
  ) +
  scale_x_continuous(labels = label_pp) +
  labs(
    x = "Effect of hemispheric laterality\n on the probability of receiving neurosurgical intervention",
    y = NULL, caption = "80% and 95% credible intervals shown in black"
  ) +
  theme_clean()


```

### Posterior Simulation

### Analysis
